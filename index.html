<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Slot Game - White Spin Wheel</title>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@600;800&family=Orbitron:wght@500;700&display=swap');

    :root{
      --tile: 18vmin;
      --spin-size: clamp(64px, 14vmin, 120px);
      --step-size: clamp(48px, 10vmin, 80px);
      --gap: 2.2vmin;

      --gold-dk:#7a4f02; --gold:#e3b653; --gold-hi:#ffe69a;
      --hud-stroke:rgba(255,215,120,.58);
      --led-amber:#ffd66d;

      --slot-w: calc(var(--tile) * 5);
      --slot-h: calc(var(--tile) * 3);

      --radius-lg: clamp(12px, 2.2vmin, 24px);
      --radius-md: clamp(10px, 1.8vmin, 16px);
      --inset: clamp(8px, 1.2vmin, 12px);
    }

    *{margin:0;padding:0;box-sizing:border-box}
    html,body{height:100%}

    /* ===== BACKGROUND: صورتك ===== */
    body{
      min-height:100svh;
      display:flex; flex-direction:column; align-items:center;
      padding:clamp(10px,2vmin,24px);
      color:#fff;
      overflow:hidden;
      background: url("images/background.png") no-repeat center center fixed;
      background-size: cover;
    }

    /* ===== HUD (Credits + Win Badge) ===== */
    .top-hud{
      position:fixed; left:50%; top:calc(8px + env(safe-area-inset-top, 0px));
      transform:translateX(-50%); z-index:10010;
      display:flex; align-items:center; gap:1.2vmin;
      padding:.8vmin 1.2vmin; border-radius:12px;
      background:rgba(20,20,24,.35);
      backdrop-filter: blur(6px); -webkit-backdrop-filter: blur(6px);
      border:1px solid rgba(255,255,255,.12);
      box-shadow: 0 .8vmin 2vmin rgba(0,0,0,.35), inset 0 0 3vmin rgba(255,215,120,.08);
    }
    .top-hud .label{
      font:800 clamp(11px,1.8vmin,13px)/1 "Cairo",system-ui,sans-serif;
      color:var(--gold-hi); opacity:.95;
    }
    #creditsTop{
      min-width: clamp(86px, 15vmin, 140px);
      text-align:center; padding:.6vmin 1vmin; border-radius:10px;
      font-family:"Orbitron",system-ui,sans-serif; font-weight:700;
      font-variant-numeric: tabular-nums;
      font-size: clamp(16px, 2.6vmin, 24px); letter-spacing:.5px;
      color:var(--led-amber);
      background:linear-gradient(180deg, rgba(12,16,22,.35), rgba(6,8,12,.2));
      border:1px solid rgba(255,178,0,.35);
      text-shadow:0 0 .6vmin rgba(255,178,0,.75),0 .1vmin 0 #2a1500;
    }
    .win-badge{
      display:inline-flex; align-items:center; justify-content:center;
      min-width: clamp(70px, 16vmin, 160px);
      height: clamp(32px, 6.4vmin, 48px);
      padding: .4vmin .9vmin; border-radius:10px;
      font-family:"Orbitron",system-ui,sans-serif; font-weight:700;
      font-variant-numeric: tabular-nums;
      font-size: clamp(14px, 2.4vmin, 20px);
      color:var(--led-amber);
      background:linear-gradient(180deg, rgba(12,16,22,.45), rgba(6,8,12,.28));
      border:1px solid rgba(255,178,0,.35);
      text-shadow:0 0 .6vmin rgba(255,178,0,.75),0 .1vmin 0 #2a1500;
      opacity:0; transform: translateY(-6px) scale(.92);
      pointer-events:none;
    }
    .win-badge.show{ animation: badgePop 1.6s cubic-bezier(.22,1,.36,1) forwards; }
    @keyframes badgePop{
      0%{ opacity:0; transform: translateY(-6px) scale(.92) }
      10%{ opacity:1; transform: translateY(0) scale(1) }
      80%{ opacity:1; transform: translateY(0) scale(1) }
      100%{ opacity:0; transform: translateY(-4px) scale(.96) }
    }
    .credits-pulse{ animation: creditsPulse .9s ease; }
    @keyframes creditsPulse{
      0%{ box-shadow: 0 0 .6vmin rgba(255,178,0,.9), 0 0 1.2vmin rgba(255,178,0,.6) }
      100%{ box-shadow: 0 0 0 rgba(0,0,0,0) }
    }

    /* ===== MACHINE (black + golden separators) ===== */
    .machine-frame{
      display:inline-flex; justify-content:center; align-items:center;
      padding:clamp(12px,2.4vmin,28px);
      border-radius:var(--radius-lg);
      background:#000;
      box-shadow:
        0 3vmin 8vmin rgba(0,0,0,.75),
        inset 0 0 0 .2vmin rgba(255,215,0,.12),
        0 0 4vmin rgba(255,215,0,.08);
      margin-top: calc(48px + env(safe-area-inset-top, 0px));
    }
    .slot-container{
      width:var(--slot-w); height:var(--slot-h);
      position:relative; overflow:hidden; border-radius:var(--radius-md);
      background:#000;
      box-shadow: 0 0 0 .12vmin rgba(0,0,0,.6) inset, 0 0 0 1vmin rgba(0,0,0,.6) inset;
      transform: translateZ(0);
    }
    .slot-container::before{
      content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none; z-index:2;
      box-shadow:
        inset 0 0 0 .6vmin var(--gold-dk),
        inset 0 0 0 .9vmin var(--gold),
        inset 0 0 0 1.2vmin var(--gold-dk),
        inset 0 0 4vmin rgba(255,215,0,.18);
    }
    .slot-container::after{
      content:""; position:absolute; inset:var(--inset); border-radius:calc(var(--radius-md) - .4vmin); pointer-events:none; z-index:1;
      box-shadow: inset 0 0 3vmin rgba(0,0,0,.6), inset 0 1vmin 3vmin rgba(0,0,0,.6);
    }

    .reels{display:flex; width:100%; height:100%}
    .reel{flex:1; overflow:hidden; position:relative}
    .reel:not(:first-child)::before{
      content:""; position:absolute; top:var(--inset); bottom:var(--inset); left:-.2vmin; width:.5vmin; border-radius:.4vmin; z-index:2;
      background:linear-gradient(180deg, var(--gold-hi), var(--gold) 50%, var(--gold-dk));
      box-shadow:0 0 1.2vmin rgba(255,215,0,.25), inset 0 0 .4vmin rgba(0,0,0,.35);
      pointer-events:none;
    }
    .reel-inner{position:relative; width:100%; will-change:transform}
    .symbol{ width:var(--tile); height:var(--tile); position:absolute; left:50%; transform:translateX(-50%) }
    .symbol-img{
      width:100%; height:100%; background-size:var(--tile) var(--tile); background-position:center; background-repeat:no-repeat;
      image-rendering:-webkit-optimize-contrast;
    }

    .symbol-img.win-flash{position:relative;animation:superFlash 2.5s infinite ease-in-out;z-index:3}
    @keyframes superFlash{
      0%{transform:scale(1);filter:hue-rotate(0deg)}
      25%{transform:scale(1.08);filter:hue-rotate(90deg)}
      50%{transform:scale(1);filter:hue-rotate(180deg)}
      75%{transform:scale(1.08);filter:hue-rotate(270deg)}
      100%{transform:scale(1);filter:hue-rotate(360deg)}
    }

    @keyframes spinDown{
      0%   { transform: translateY(calc(var(--tile) * -21)); }
      10%  { transform: translateY(calc(var(--tile) * -19)); }
      70%  { transform: translateY(calc(var(--tile) * -13.5)); }
      88%  { transform: translateY(calc(var(--tile) * -12.25)); }
      94%  { transform: translateY(calc(var(--tile) * -11.8)); }
      100% { transform: translateY(calc(var(--tile) * -12)); }
    }

    /* ===== SPIN ROW ===== */
    .spin-row{ width:100%; display:flex; justify-content:center; margin-top:var(--gap); }
    .spin-row-inner{ width:var(--slot-w); display:flex; align-items:center; justify-content:center; gap:var(--gap); }

    .step-btn, #spinBtn, #moreBtn{ touch-action:manipulation; }
    .step-btn{
      width:var(--step-size); height:var(--step-size);
      border-radius:50%; border:1.5px solid var(--hud-stroke);
      background:linear-gradient(180deg,#1e252d,#0b0f15);
      box-shadow: 0 .8vmin 2vmin rgba(0,0,0,.35), inset 0 0 3vmin rgba(255,215,120,.08);
      color:#fff; font-size:clamp(22px,4.8vmin,30px); line-height:1; cursor:pointer;
      display:flex; align-items:center; justify-content:center; user-select:none;
    }
    .step-btn:active{transform:scale(.95)}
    #spinBtn{
      width:var(--spin-size); height:var(--spin-size); background:none; border:none; cursor:pointer; padding:0;
      filter:drop-shadow(0 0 .6vmin rgba(0,0,0,.55));
    }
    #spinBtn img{width:100%;height:100%;display:block;object-fit:contain;animation:wheelMotion 3s infinite linear;filter:drop-shadow(0 0 1vmin rgba(255,255,255,.85))}
    #spinBtn:active img{animation-play-state:paused;transform:scale(.86)}
    @keyframes wheelMotion{0%{transform:rotate(0)}50%{transform:rotate(180deg)}100%{transform:rotate(360deg)}}

    #moreBtn{
      width: clamp(44px, 8.5vmin, 64px); height: clamp(44px, 8.5vmin, 64px);
      border-radius:12px; border:1.5px solid var(--hud-stroke);
      background:linear-gradient(180deg,#1e252d,#0b0f15); color:#fff; font-size:clamp(20px,4.2vmin,26px);
      display:flex; align-items:center; justify-content:center;
    }

    /* ===== Bottom sheet ===== */
    .sheet{
      position:fixed; left:50%; transform:translateX(-50%) translateY(100%);
      bottom:0; width:min(96vw, 520px);
      background:rgba(18,20,24,.96); color:#fff; border-radius:16px 16px 0 0;
      border:1px solid rgba(255,255,255,.12); padding:16px; z-index:10020;
      box-shadow:0 -10px 40px rgba(0,0,0,.5);
      transition:transform .28s ease;
    }
    .sheet.open{ transform:translateX(-50%) translateY(0) }
    .sheet header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .sheet h3{font:800 16px/1 "Cairo",system-ui,sans-serif}
    .sheet .close{background:none;border:none;color:#fff;font-size:24px;cursor:pointer}

    .sheet .row{display:flex;gap:10px;align-items:center;margin:10px 0;flex-wrap:wrap}
    .sheet .row .info{
      padding:10px 12px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02)),linear-gradient(180deg,#13171d,#0a0d11 60%,#07090c);
      border:1.5px solid var(--hud-stroke);display:flex;align-items:center;gap:10px
    }
    .sheet label{
      font:800 13px/1 "Cairo",system-ui,sans-serif;
      color:var(--gold-hi);
      background-image:linear-gradient(180deg,#fff2b8,#e8be6a 55%,#7a4f02);
      -webkit-background-clip:text;-webkit-text-fill-color:transparent;
      white-space:nowrap;
      text-shadow:0 0 .3vmin rgba(255,255,255,.35),0 .2vmin .1vmin rgba(0,0,0,.55);
    }
    .sheet select, .sheet input[type="number"], .sheet .value-box{
      width: clamp(90px, 26vw, 140px);
      height: clamp(40px, 7vmin, 54px);
      color:var(--led-amber);
      background:linear-gradient(180deg,#11161d,#0b0f15 60%,#090d13);
      border:1px solid rgba(255,178,0,.4); border-radius:10px; padding:.6vmin 1vmin; font-family:"Orbitron",system-ui,sans-serif;
    }
    .sheet .value-box{display:flex; align-items:center; justify-content:center; font-weight:700;}

    /* ===== Toast (Bet only) ===== */
    .toast{
      position:fixed; left:50%; transform:translateX(-50%);
      z-index:10050; padding:.9rem 1.2rem; border-radius:12px;
      background:rgba(0,0,0,.75); color:#fff; border:1px solid rgba(255,255,255,.15);
      font:800 clamp(18px,3.6vmin,26px)/1.2 "Cairo", system-ui, sans-serif;
      box-shadow:0 10px 24px rgba(0,0,0,.4);
      pointer-events:none;
    }
    .toast.bet{ bottom: 14%; font-size: clamp(14px, 3vmin, 20px); }

    /* ===== Audio ===== */
    .audio-icon{
      font-size: clamp(20px, 3.6vmin, 24px);
      width: clamp(40px, 7vmin, 52px); height: clamp(40px, 7vmin, 52px);
      border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none;
      background: linear-gradient(180deg,#1e252d,#0b0f15);
      border:1.5px solid var(--hud-stroke);
      box-shadow: 0 .8vmin 2vmin rgba(0,0,0,.35), inset 0 0 3vmin rgba(255,215,120,.08);
    }
    .audio-panel{
      position:fixed; top: 2vmin; right: 2vmin; width: clamp(220px, 40vmin, 280px);
      background:#222; border:1px solid #444; border-radius:1.2vmin; padding:1.2vmin; display:none; z-index:9999
    }
    .audio-panel h3{margin-bottom:1vmin;text-align:center}
    .sound-control{display:flex;flex-direction:column;margin-bottom:1.2vmin}
    .sound-control label{margin-bottom:.6vmin;font-size: clamp(12px, 1.8vmin, 14px);font-weight:bold}
    .sound-control input[type="range"]{width:100%}
    .mute-row{display:flex;align-items:center;justify-content:space-between}

    .intro-overlay{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:1000000}
    .intro-overlay video{width:100vw;height:100vh;object-fit:contain;background:#000}

    @media (max-width: 600px){
      .spin-row-inner{flex-wrap:wrap; gap:calc(var(--gap) * .8)}
      #moreBtn{ order: 3; }
    }
    @media (min-width: 1200px){
      :root{ --spin-size: clamp(84px, 10vmin, 130px); --step-size: clamp(56px, 8vmin, 96px); }
    }
  </style>
</head>
<body>

  <!-- HUD -->
  <div class="top-hud" aria-live="polite">
    <span class="label">Credits</span>
    <span id="creditsTop">1000</span>
    <span id="winBadge" class="win-badge" hidden>+0</span>
  </div>

  <!-- Intro -->
  <div id="introOverlay" class="intro-overlay">
    <video id="introVideo" src="aa.mp4" preload="auto" autoplay muted playsinline webkit-playsinline></video>
  </div>

  <div class="machine-frame">
    <div class="slot-container">
      <div class="reels" id="reels"><!-- built by JS --></div>
    </div>
  </div>

  <!-- Spin row -->
  <div class="spin-row">
    <div class="spin-row-inner">
      <button id="betMinus" class="step-btn" aria-label="Decrease bet">−</button>
      <button id="spinBtn" aria-label="Spin"><img src="images/spin.png" alt="Spin" /></button>
      <button id="betPlus" class="step-btn" aria-label="Increase bet">+</button>
      <button id="moreBtn" class="step-btn" aria-label="Settings">⋮</button>
      <div class="audio-icon" id="audioIcon" title="Sound">🔊</div>
    </div>
  </div>

  <!-- Settings sheet -->
  <div id="settingsSheet" class="sheet" aria-hidden="true">
    <header>
      <h3>Settings</h3>
      <button class="close" id="sheetClose" aria-label="Close">×</button>
    </header>
    <div class="row">
      <div class="info">
        <label for="linesCount">Lines:</label>
        <select id="linesCount">
          <option value="1" selected>1</option>
          <option value="5">5</option>
          <option value="10">10</option>
          <option value="20">20</option>
        </select>
      </div>
      <div class="info">
        <label for="betPerLine">Bet/Line:</label>
        <input type="number" id="betPerLine" value="1" min="1" />
      </div>
      <div class="info">
        <label>Last Win:</label>
        <div class="value-box" id="lastWin">0</div>
      </div>
    </div>
  </div>

  <!-- Audio panel -->
  <div class="audio-panel" id="audioPanel">
    <h3>Sound Settings</h3>
    <div class="sound-control">
      <label>Music</label>
      <input type="range" min="0" max="1" step="0.01" value="1" data-sound="music" class="volume-slider" />
      <div class="mute-row"><span>Mute</span><input type="checkbox" data-mute="music" /></div>
    </div>
    <div class="sound-control">
      <label>Spin</label>
      <input type="range" min="0" max="1" step="0.01" value="1" data-sound="spin" class="volume-slider" />
      <div class="mute-row"><span>Mute</span><input type="checkbox" data-mute="spin" /></div>
    </div>
    <div class="sound-control">
      <label>Reels</label>
      <input type="range" min="0" max="1" step="0.01" value="1" data-sound="dd" class="volume-slider" />
      <div class="mute-row"><span>Mute</span><input type="checkbox" data-mute="dd" /></div>
    </div>
    <div class="sound-control">
      <label>Win</label>
      <input type="range" min="0" max="1" step="0.01" value="1" data-sound="win" class="volume-slider" />
      <div class="mute-row"><span>Mute</span><input type="checkbox" data-mute="win" /></div>
    </div>
    <div class="sound-control">
      <label>Bonus</label>
      <input type="range" min="0" max="1" step="0.01" value="1" data-sound="bonus" />
      <div class="mute-row"><span>Mute</span><input type="checkbox" data-mute="bonus" /></div>
    </div>
  </div>

  <script>
    /* =================== SOUND & GLOBALS =================== */
    let freeSpins = 0;
    let isBonusActive = false;

    const musicSound = new Audio("sounds/music.mp3"); musicSound.loop = true; musicSound.muted = true;
    const spinSound  = new Audio("sounds/spin.mp3");
    const ddSound    = new Audio("sounds/dd.mp3");
    const winSound   = new Audio("sounds/win.mp3");
    const bonusSound = new Audio("sounds/bonus.mp3");
    const crashSound = new Audio("sounds/crash.mp3"); crashSound.loop = true;

    const soundsMap = { music:musicSound, spin:spinSound, dd:ddSound, win:winSound, bonus:bonusSound, crash:crashSound };

    window.addEventListener("load", () => {
      musicSound.play().catch(() => {
        document.addEventListener("click", function onceClick(){
          musicSound.play().catch(()=>{});
          document.removeEventListener("click", onceClick);
        });
      });
    });

    /* Audio Panel */
    (function setupAudioPanel(){
      const audioIcon=document.getElementById("audioIcon");
      const audioPanel=document.getElementById("audioPanel");
      let open=false;
      function show(){audioPanel.style.display="block";open=true;}
      function hide(){audioPanel.style.display="none";open=false;}
      audioIcon.addEventListener("click",(e)=>{e.stopPropagation();open?hide():show();});
      document.addEventListener("click",(e)=>{ if(!open) return; if(!audioPanel.contains(e.target) && e.target!==audioIcon) hide();});
      audioPanel.addEventListener("click",(e)=>e.stopPropagation());
      document.addEventListener("keydown",(e)=>{if(e.key==="Escape" && open) hide();});
      document.querySelectorAll(".volume-slider").forEach(sl=>{
        sl.addEventListener("input",(e)=>{const k=e.target.dataset.sound;const v=parseFloat(e.target.value); if(soundsMap[k]) soundsMap[k].volume = isFinite(v) ? v : 1;});
      });
      document.querySelectorAll("input[type='checkbox'][data-mute]").forEach(ch=>{
        ch.addEventListener("change",(e)=>{const k=e.target.dataset.mute; if(soundsMap[k]) soundsMap[k].muted=!!e.target.checked;});
      });
    })();

    /* Intro Video */
    (function setupIntroVideo(){
      const overlay=document.getElementById("introOverlay");
      const video=document.getElementById("introVideo");
      if(!overlay||!video) return;
      video.muted=true; video.setAttribute('playsinline',''); video.setAttribute('webkit-playsinline',''); video.autoplay=true;

      window.addEventListener("load",()=>{
        try{ musicSound.pause(); }catch(e){}
        const p=video.play();
        if(p && typeof p.catch==="function"){
          p.catch(()=>{
            const tap=()=>{ video.play().catch(()=>{}); overlay.removeEventListener("click", tap); };
            overlay.addEventListener("click", tap);
          });
        }
      });
      video.addEventListener("ended",()=>{
        overlay.style.display="none";
        try{ musicSound.muted=false; musicSound.currentTime=0; musicSound.play().catch(()=>{}); }catch(e){}
      },{once:true});
    })();

    /* ===== Utils ===== */
    function toInt(v,d){const n=parseInt(v,10);return Number.isFinite(n)?n:d;}
    function clamp(n,min,max){return Math.min(max,Math.max(min,n));}
    function fixNumber(n,def=0){n=Number(n);return Number.isFinite(n)?n:def;}
    function getCssNumber(name){ return parseFloat(getComputedStyle(document.documentElement).getPropertyValue(name)) || 0; }
    function rand(){ const c=(window.crypto||window.msCrypto); if(c&&c.getRandomValues){const a=new Uint32Array(1); c.getRandomValues(a); return a[0]/4294967296;} return Math.random(); }
    function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } return arr; }

    /* ===== Symbols / Strips ===== */
    function getSymbolBackground(symUrl){return `url("${symUrl}"), url("images/d1.png")`;}
    const symbolsArr=[
      {name:"d1",url:"images/d1.png"},{name:"d2",url:"images/d2.png"},
      {name:"d3",url:"images/d3.png"},{name:"d4",url:"images/d4.png"},
      {name:"d5",url:"images/d5.png"},{name:"d6",url:"images/d6.png"},
      {name:"d7",url:"images/d7.png"},{name:"d8",url:"images/d8.png"},
      {name:"wild",url:"images/wild.png"},{name:"scatter",url:"images/scatter.png"},
      {name:"bonus",url:"images/bonus.png"}
    ];
    function symbolByName(n){return symbolsArr.find(s=>s.name===n);}

    function buildStrip(counts){
      const arr=[]; for(const [name,cnt] of Object.entries(counts)){for(let i=0;i<cnt;i++) arr.push(name);}
      for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];}
      return arr;
    }
    const REEL_STRIPS_NAMES=[
      buildStrip({d1:24,d2:20,d3:16,d4:13,d5:8,d6:5,d7:2,d8:1,wild:1,scatter:1,bonus:1}),
      buildStrip({d1:23,d2:20,d3:16,d4:13,d5:8,d6:5,d7:2,d8:1,wild:1,scatter:1,bonus:1}),
      buildStrip({d1:22,d2:19,d3:16,d4:13,d5:8,d6:5,d7:2,d8:1,wild:1,scatter:1,bonus:1}),
      buildStrip({d1:21,d2:19,d3:16,d4:12,d5:8,d6:5,d7:2,d8:1,wild:1,scatter:1,bonus:1}),
      buildStrip({d1:20,d2:18,d3:16,d4:12,d5:8,d6:5,d7:2,d8:1,wild:1,scatter:1,bonus:1})
    ];
    const REEL_STRIPS = REEL_STRIPS_NAMES.map(strip=>strip.map(symbolByName));

    const RNG_WEIGHTS_TAIL={d1:180,d2:160,d3:140,d4:120,d5:100,d6:80,d7:60,d8:50,wild:1,scatter:1,bonus:1};
    const weightArray=symbolsArr.map(s=>RNG_WEIGHTS_TAIL[s.name]||1);
    const totalWeight=weightArray.reduce((a,b)=>a+b,0);
    function pickWeightedSymbol(){
      let r=Math.random()*totalWeight;
      for(let i=0;i<symbolsArr.length;i++){ r-=weightArray[i]; if(r<=0) return symbolsArr[i]; }
      return symbolsArr[symbolsArr.length-1];
    }

    const MAX_WIN_MULTIPLIER=3;      // سقف أي فوز = 3× إجمالي الرهان
    const FREE_SPINS_COUNT=3;

    /* ===== UI refs ===== */
    const linesCountSelect = document.getElementById("linesCount");
    const betPerLineInput  = document.getElementById("betPerLine");
    const creditsTop       = document.getElementById("creditsTop");
    const lastWinSpan      = document.getElementById("lastWin");
    const spinBtn          = document.getElementById("spinBtn");
    const betPlusBtn       = document.getElementById("betPlus");
    const betMinusBtn      = document.getElementById("betMinus");
    const moreBtn          = document.getElementById("moreBtn");
    const settingsSheet    = document.getElementById("settingsSheet");
    const sheetClose       = document.getElementById("sheetClose");
    const winBadge         = document.getElementById("winBadge");

    const reelsCount=5, rowsCount=3;
    const payLines=[
      [0,0,0,0,0],[1,1,1,1,1],[2,2,2,2,2],[0,1,2,1,0],[2,1,0,1,2],
      [0,0,1,2,2],[2,2,1,0,0],[1,0,0,0,1],[1,2,2,2,1],[1,0,1,2,1]
    ];

    function getActivePayLinesCount(){
      const n = clamp(toInt(linesCountSelect.value,1),1,payLines.length);
      if(linesCountSelect.value!==String(n)) linesCountSelect.value=String(n); return n;
    }
    function getBetPerLine(){
      let n = toInt(betPerLineInput.value,1);
      if(!Number.isFinite(n) || n<1) n=1;
      if(String(n)!==betPerLineInput.value) betPerLineInput.value=String(n);
      return n;
    }
    betPerLineInput.addEventListener('input', ()=>{ betPerLineInput.value=String(Math.max(1,toInt(betPerLineInput.value,1))); showBetToast(); });
    betPerLineInput.addEventListener('blur',  ()=>{ betPerLineInput.value=String(Math.max(1,toInt(betPerLineInput.value,1))); showBetToast(); });
    linesCountSelect.addEventListener('change',()=>{ linesCountSelect.value=String(getActivePayLinesCount()); showBetToast(); });

    let credits=1000, lastWin=0, isSpinning=false;

    /* ===== Toast (Bet) ===== */
    function centerToast(text, cls='bet', ms=1200){
      const t=document.createElement('div');
      t.className=`toast ${cls}`;
      t.textContent=text;
      document.body.appendChild(t);
      setTimeout(()=>{ if(t&&t.parentNode) t.parentNode.removeChild(t); }, ms);
    }
    function totalBetNow(){ return getActivePayLinesCount() * getBetPerLine(); }
    function showBetToast(){ centerToast(`Bet / Spin: ${totalBetNow()}`, 'bet', 1200); }

    /* ===== Number animation ===== */
    function animateNumber(el, from, to, ms=800){
      const start=performance.now();
      function step(now){
        const t=Math.min(1, (now-start)/ms);
        const val=Math.floor(from + (to-from)*t);
        el.textContent = String(val);
        if(t<1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }
    function showWinBadge(amount){
      if(typeof amount === 'number') amount = `+${amount}`;
      winBadge.textContent = amount;
      winBadge.hidden = false;
      winBadge.classList.remove('show'); void winBadge.offsetWidth; winBadge.classList.add('show');
      setTimeout(()=>{ winBadge.hidden = true; }, 1600);
      creditsTop.classList.remove('credits-pulse'); void creditsTop.offsetWidth; creditsTop.classList.add('credits-pulse');
    }

    function updateHUD(){
      credits=Math.max(0,Math.floor(fixNumber(credits,0)));
      lastWin=Math.max(0,Math.floor(fixNumber(lastWin,0)));
      creditsTop.textContent = String(credits);
      lastWinSpan.textContent = String(lastWin);
    }

    /* ===== Reels build ===== */
    function createReelsLayout(){
      const reelsWrapper=document.getElementById("reels"); reelsWrapper.innerHTML="";
      for(let c=0;c<reelsCount;c++){const reel=document.createElement("div");reel.className="reel";reelsWrapper.appendChild(reel);}
    }
    function TILE(){ return getCssNumber('--tile'); }
    function buildReelSymbolsArray(reelIndex){
      const arr=[];
      for(let i=0;i<12;i++) arr.push(pickWeightedSymbol());
      for(let r=0;r<rowsCount;r++) arr.push(spinFinalResult[r][reelIndex]);
      for(let j=0;j<10;j++) arr.push(pickWeightedSymbol());
      return arr;
    }
    function renderReelsStatic(){
      const reelDivs=document.querySelectorAll(".reel");
      for(let c=0;c<reelsCount;c++){
        const inner=document.createElement("div"); inner.className="reel-inner";
        const reelSymbols=buildReelSymbolsArray(c);
        inner.style.height=(reelSymbols.length * TILE())+"px";
        reelSymbols.forEach((sym,idx)=>{
          const d=document.createElement("div"); d.className="symbol"; d.style.top=(idx * TILE())+"px";
          const img=document.createElement("div"); img.className="symbol-img"; img.style.backgroundImage=getSymbolBackground(sym.url);
          d.appendChild(img); inner.appendChild(d);
        });
        reelDivs[c].appendChild(inner);
      }
    }

    const reelDurations=[0.60,0.70,0.80,0.90,1.00];
    let spinFinalResult=[];

    function generateSpinResult(){
      const res=[[],[],[]];
      for(let c=0;c<reelsCount;c++){
        const strip=REEL_STRIPS[c], len=strip.length, start=Math.floor(Math.random()*len);
        res[0][c]=strip[start]; res[1][c]=strip[(start+1)%len]; res[2][c]=strip[(start+2)%len];
      } return res;
    }

    /* ===== Win evaluation ===== */
    function countSymbolInAll(spinResult,name){
      let cnt=0; for(let r=0;r<rowsCount;r++){for(let c=0;c<reelsCount;c++){if(spinResult[r][c].name===name) cnt++;}} return cnt;
    }
    function calculateLineWin(lineSyms,betVal){
      const payTable={
        "d1":[0,0,2,3,4],"d2":[0,0,2,3,5],"d3":[0,0,3,4,6],"d4":[0,0,3,5,7],
        "d5":[0,0,3,5,9],"d6":[0,0,3,6,11],"d7":[0,0,4,8,12],"d8":[0,0,5,9,14],
        "wild":[0,0,0,0,0],"scatter":[0,0,0,0,0],"bonus":[0,0,0,0,0]
      };
      let base=null,count=0;
      for(let i=0;i<lineSyms.length;i++){
        const n=lineSyms[i].name;
        if(i===0){ if(n!=="wild") base=n; count=1; }
        else{
          if(n===base || n==="wild") count++;
          else if(base===null && n!=="wild"){ base=n; count=1; }
          else break;
        }
      }
      let amt=0;
      if(base && payTable[base] && count>=3){ if(count>5) count=5; amt=payTable[base][count]*betVal; }
      return {amount:amt, count};
    }
    function evaluateWin(spinResult, opts={}){
      const dry = !!opts.dry;
      let total=0; const linesActive=getActivePayLinesCount(); const betVal=getBetPerLine(); const totalBet=linesActive*betVal;

      for(let i=0;i<linesActive;i++){
        const pattern=payLines[i], line=[]; for(let c=0;c<reelsCount;c++){ line.push(spinResult[pattern[c]][c]); }
        const w=calculateLineWin(line,betVal); total+=w.amount;
        if(w.count>=3 && !dry) highlightWinningSymbols(i,w.count);
      }

      const sc=countSymbolInAll(spinResult,"scatter"); if(sc>=3){ const t={3:1,4:2,5:4}; total+=(t[sc]||4)*betVal; }
      const bn=countSymbolInAll(spinResult,"bonus");
      if(bn>=3 && !dry){
        total+=(bn*5)*betVal; bonusSound.currentTime=0; bonusSound.play().catch(()=>{});
        freeSpins=FREE_SPINS_COUNT; isBonusActive=true;
        musicSound.pause(); musicSound.currentTime=0; crashSound.currentTime=0; crashSound.play().catch(()=>{});
        showWinBadge(`FS ${FREE_SPINS_COUNT}`);
      }
      const cap=MAX_WIN_MULTIPLIER*totalBet; if(total>cap) total=cap;
      return total;
    }
    function highlightWinningSymbols(lineIndex,count){
      const pattern=payLines[clamp(lineIndex,0,payLines.length-1)];
      const reelDivs=document.querySelectorAll(".reel");
      for(let c=0;c<count;c++){
        const rowIndex=pattern[c], symIndex=12+rowIndex;
        const inner=reelDivs[c].querySelector(".reel-inner");
        if(inner){ const symDiv=inner.children[symIndex]; if(symDiv){ const img=symDiv.querySelector(".symbol-img"); if(img) img.classList.add("win-flash");}}
      }
    }

    /* ===== RNG/RTP Governor ===== */
    const RNG_CONF = {
      TARGET_RTP: 0.84,     // نسبة العائد للاعب (يمكن تعديلها)
      WINDOW: 320,          // نافذة متحركة لحساب الرصيد/الدفع
      pWinBase: 0.30,       // احتمال فوز أساسي
      lossBoostStep: 0.025, // +2.5% لكل خسارة متتالية
      lossBoostMax: 0.12,   // سقف البوست 12%
      streakBreakAt: 7,     // كسر سلسلة الخسارة بفوز صغير لو سمحت الميزانية
      shares: { smallScatter: 0.86, smallLine: 0.12, medium: 0.02 }
    };

    const RTP_TRACK = { window: RNG_CONF.WINDOW, q: [], spent: 0, paid: 0 };
    function rtpPush(spent, paid){
      RTP_TRACK.q.push({spent, paid});
      RTP_TRACK.spent += spent; RTP_TRACK.paid += paid;
      while(RTP_TRACK.q.length > RNG_CONF.WINDOW){
        const old = RTP_TRACK.q.shift();
        RTP_TRACK.spent -= old.spent; RTP_TRACK.paid -= old.paid;
      }
    }
    function rtpAllowedForNextSpin(additionalSpend){
      const allowed = Math.floor(RNG_CONF.TARGET_RTP * (RTP_TRACK.spent + additionalSpend) - RTP_TRACK.paid);
      return Math.max(0, allowed);
    }

    function findStartsForSymbol(strip, targetName, row){
      const len=strip.length, starts=[];
      for(let s=0;s<len;s++){ if(strip[(s+row)%len].name===targetName) starts.push(s); }
      return starts;
    }
    function generateLossResult(maxTries=300){
      for(let t=0;t<maxTries;t++){
        const r=generateSpinResult();
        const amt = evaluateWin(r,{dry:true});
        const sc  = countSymbolInAll(r,"scatter");
        const bn  = countSymbolInAll(r,"bonus");
        if(amt===0 && sc<3 && bn<3) return r;
      }
      return generateSpinResult();
    }
    function generateSmallScatterWin(maxTries=400){
      const betVal=getBetPerLine();
      const minAmt=Math.max(1, Math.round(betVal*0.8));
      const maxAmt=Math.max(minAmt, Math.round(betVal*1.6));
      for(let t=0;t<maxTries;t++){
        const res=[[],[],[]]; const starts=new Array(5).fill(0);
        const chosen=shuffle([0,1,2,3,4]).slice(0,3);
        for(let c=0;c<5;c++){
          const strip=REEL_STRIPS[c], len=strip.length;
          if(chosen.includes(c)){
            const row=Math.floor(Math.random()*3);
            const pool=findStartsForSymbol(strip,"scatter",row);
            starts[c]=pool.length? pool[Math.floor(Math.random()*pool.length)] : Math.floor(Math.random()*len);
          }else{
            starts[c]=Math.floor(Math.random()*len);
          }
          res[0][c]=strip[starts[c]];
          res[1][c]=strip[(starts[c]+1)%len];
          res[2][c]=strip[(starts[c]+2)%len];
        }
        const amt=evaluateWin(res,{dry:true});
        const sc=countSymbolInAll(res,"scatter"), bn=countSymbolInAll(res,"bonus");
        if(sc>=3 && bn<3 && amt>=minAmt && amt<=maxAmt) return res;
      }
      for(let t=0;t<300;t++){
        const r=generateSpinResult();
        const a=evaluateWin(r,{dry:true});
        if(countSymbolInAll(r,"scatter")>=3 && a>0 && a<=maxAmt) return r;
      }
      return generateBiasedSmallWin();
    }
    function generateBiasedSmallWin(){
      const linesActive = getActivePayLinesCount();
      const lineIndex = Math.floor(rand()*linesActive);
      const pattern = payLines[lineIndex];
      const target = rand() < 0.65 ? "d1" : "d2";
      const res=[[],[],[]];

      for(let c=0;c<reelsCount;c++){
        const strip=REEL_STRIPS[c], len=strip.length;
        let start;
        if(c<=2){
          const pool = findStartsForSymbol(strip, target, pattern[c]);
          start = pool.length ? pool[Math.floor(rand()*pool.length)] : Math.floor(rand()*len);
        }else{
          let tries=0;
          do{
            start = Math.floor(rand()*len);
            const nameAtRow = strip[(start+pattern[c])%len].name;
            if(nameAtRow!==target && nameAtRow!=="wild") break;
            tries++;
          }while(tries<60);
        }
        res[0][c]=strip[start];
        res[1][c]=strip[(start+1)%len];
        res[2][c]=strip[(start+2)%len];
      }
      return res;
    }
    function generateDecentWin(){
      const linesActive = getActivePayLinesCount();
      const lineIndex = Math.floor(rand()*linesActive);
      const pattern = payLines[lineIndex];
      const choices = ["d3","d4","d5"];
      const target = choices[Math.floor(rand()*choices.length)];
      const res=[[],[],[]];

      for(let c=0;c<reelsCount;c++){
        const strip=REEL_STRIPS[c], len=strip.length;
        let start;
        if(c<=3){
          const pool = findStartsForSymbol(strip, target, pattern[c]);
          start = pool.length ? pool[Math.floor(rand()*pool.length)] : Math.floor(rand()*len);
        }else{
          let tries=0;
          do{
            start = Math.floor(rand()*len);
            const nameAtRow = strip[(start+pattern[c])%len].name;
            if(nameAtRow!==target && nameAtRow!=="wild") break;
            tries++;
          }while(tries<60);
        }
        res[0][c]=strip[start];
        res[1][c]=strip[(start+1)%len];
        res[2][c]=strip[(start+2)%len];
      }
      return res;
    }

    /* ===== Choose outcome with stake-refund budget ===== */
    function restrictToBudget(gen, limit, fallback){
      for(let t=0;t<220;t++){
        const cand = gen();
        const amt  = evaluateWin(cand,{dry:true});
        if(amt <= limit) return cand;
      }
      return fallback ? fallback() : generateLossResult();
    }
    function chooseOutcome(totalBet, allowed, pWinEff, forceSmall=false, stakeRefund=0){
      // لا يمكن دفع أكثر من الميزانية، والميزانية يجب أن تغطي ردّ الرهان أولاً
      const allowedLess = Math.max(0, allowed - stakeRefund);

      // لو الميزانية لا تكفي حتى لأصغر فوز → خسارة
      const betVal=getBetPerLine();
      const minScatter = Math.max(1, Math.round(betVal*0.8));
      if(allowedLess < minScatter) return generateLossResult();

      // قرعة الفوز/الخسارة (مع فرض فوز صغير لكسر الملل عند الحاجة)
      if (!forceSmall && Math.random() >= pWinEff) return generateLossResult();

      const s = RNG_CONF.shares;
      const r = Math.random();
      const minSmallLine = Math.max(1, Math.round(betVal*2));
      const minMedium    = Math.max(1, Math.round(totalBet*1.2));

      if (!forceSmall && r < s.medium && allowedLess >= minMedium){
        return restrictToBudget(
          generateDecentWin,
          allowedLess,
          ()=>restrictToBudget(generateBiasedSmallWin, allowedLess, ()=>restrictToBudget(generateSmallScatterWin, allowedLess))
        );
      }
      if (!forceSmall && r < s.medium + s.smallLine && allowedLess >= minSmallLine){
        return restrictToBudget(
          generateBiasedSmallWin,
          allowedLess,
          ()=>restrictToBudget(generateSmallScatterWin, allowedLess)
        );
      }
      return restrictToBudget(generateSmallScatterWin, allowedLess, ()=>generateLossResult());
    }

    /* ===== Spin flow ===== */
    let lossStreak = 0;
    let lastDeductedBet = 0; // رهان هذه اللفة (يُعاد عند الفوز)
    let spentThisSpin = 0;   // ما خُصم فعلياً (أو 0 في اللفات المجانية)

    function finalizeSpin(){
      ddSound.pause(); ddSound.currentTime=0;

      const prevCredits = credits;
      const winAmount = Math.max(0, Math.floor(fixNumber(evaluateWin(spinFinalResult),0)));

      // ===== ردّ الرهان أولاً ثم إضافة الربح =====
      let paidThisSpin = 0;
      if(winAmount > 0){
        const refund = lastDeductedBet;     // قد يكون 0 في اللفات المجانية
        credits += refund + winAmount;
        paidThisSpin = refund + winAmount;  // مهم للـRTP
        lossStreak = 0;
        showWinBadge(winAmount);
        animateNumber(creditsTop, prevCredits, credits, 850);
        winSound.currentTime=0; winSound.play().catch(()=>{});
      }else{
        // خسارة: لا رد رهان ولا ربح
        lossStreak++;
        creditsTop.textContent = String(credits);
      }

      lastWin = winAmount;
      lastWinSpan.textContent = String(lastWin);
      isSpinning=false;

      // تحديث تتبّع RTP (الدفع يشمل ردّ الرهان عند الفوز)
      rtpPush(spentThisSpin, paidThisSpin);
      spentThisSpin = 0;
      lastDeductedBet = 0;

      if(isBonusActive){
        if(freeSpins>0){ setTimeout(()=>{freeSpins--; doSpin();},300); }
        else{
          isBonusActive=false; crashSound.pause(); crashSound.currentTime=0; musicSound.currentTime=0; musicSound.play().catch(()=>{});
          spinBtn.disabled=false;
        }
      }else{ spinBtn.disabled=false; }
    }

    function doSpin(){
      if(isSpinning) return;

      credits=fixNumber(credits,0);
      spentThisSpin = 0;
      lastDeductedBet = 0;

      const lines=getActivePayLinesCount();
      const betVal=getBetPerLine();
      const totalBet=lines*betVal;

      // خصم الرهان (إلا في اللفات المجانية)
      if(!isBonusActive || freeSpins<=0){
        if(!Number.isFinite(totalBet) || totalBet<=0){ alert("Bet value is invalid."); return; }
        if(totalBet>credits){ alert("Insufficient credits!"); return; }
        credits -= totalBet;
        lastDeductedBet = totalBet;
        spentThisSpin   = totalBet;
        creditsTop.textContent = String(credits);
      }

      isSpinning=true; spinBtn.disabled=true;
      spinSound.currentTime=0; spinSound.play().catch(()=>{});

      const allowed   = rtpAllowedForNextSpin(spentThisSpin);
      const boost     = Math.min(RNG_CONF.lossBoostMax, lossStreak * RNG_CONF.lossBoostStep);
      const pWinEff   = Math.max(0, Math.min(0.60, RNG_CONF.pWinBase + boost));  // سقف 60%

      const forceSmall = (lossStreak >= RNG_CONF.streakBreakAt);
      const stakeRefundIfWin = lastDeductedBet; // 0 لو كانت لفّة مجانية

      spinFinalResult = chooseOutcome(totalBet, allowed, pWinEff, forceSmall, stakeRefundIfWin);

      displaySpinWithAnimation();
    }

    spinBtn.addEventListener("click", ()=>{ if(isBonusActive&&freeSpins>0) return; doSpin(); });

    function displaySpinWithAnimation(){
      const reelDivs=document.querySelectorAll(".reel"); let finished=0;
      ddSound.currentTime=0; ddSound.play().catch(()=>{});
      for(let c=0;c<reelsCount;c++){
        const inner=document.createElement("div"); inner.className="reel-inner";
        const arr=buildReelSymbolsArray(c); inner.style.height=(arr.length * TILE())+"px";
        arr.forEach((sym,idx)=>{
          const d=document.createElement("div"); d.className="symbol"; d.style.top=(idx * TILE())+"px";
          const img=document.createElement("div"); img.className="symbol-img"; img.style.backgroundImage=getSymbolBackground(sym.url);
          d.appendChild(img); inner.appendChild(d);
        });
        const old=reelDivs[c].querySelector(".reel-inner"); reelDivs[c].appendChild(inner); if(old) reelDivs[c].removeChild(old);
        inner.style.animation=`spinDown ${reelDurations[c]}s forwards linear`;
        inner.addEventListener("animationend", ()=>{finished++; if(finished===reelsCount) finalizeSpin();},{once:true});
      }
    }

    /* ===== Responsive / freeze during spin ===== */
    let pendingResize = false;
    let resizeTimer = null;
    function setTile(px){ document.documentElement.style.setProperty('--tile', Math.max(40, px) + 'px'); }
    function fitToViewport(force=false){
      if (isSpinning && !force) { pendingResize = true; return; }
      const vw = Math.max(1, window.innerWidth || document.documentElement.clientWidth || 0);
      const vh = Math.max(1, (window.visualViewport ? visualViewport.height : window.innerHeight) || window.innerHeight);
      const side = Math.max(8, vw * 0.04);
      const maxTileByW = (vw - side*2) / 5;
      setTile(maxTileByW);
      const spinRow = document.querySelector('.spin-row');
      const spinH = spinRow ? spinRow.getBoundingClientRect().height : 0;
      const vMargin = Math.max(12, vh * 0.03);
      const maxTileByH = (vh - spinH - vMargin*2 - (48 + 10)) / 3;
      const tile = Math.min(maxTileByW, maxTileByH);
      setTile(tile);
      if(!isSpinning){
        createReelsLayout();
        renderReelsStatic();
      }
    }
    function scheduleFit(){
      if(isSpinning){ pendingResize = true; return; }
      if(resizeTimer) clearTimeout(resizeTimer);
      resizeTimer = setTimeout(()=>fitToViewport(true), 400);
    }
    window.addEventListener('load', ()=>{
      createReelsLayout();
      spinFinalResult=generateSpinResult();
      renderReelsStatic();
      updateHUD();
      fitToViewport();
    });
    window.addEventListener('resize', scheduleFit);
    window.addEventListener('orientationchange', scheduleFit);
    if(window.visualViewport) visualViewport.addEventListener('resize', scheduleFit);

    /* ===== + / − (±2) + bet toast ===== */
    function adjustBet(delta){
      const cur = getBetPerLine();
      const next = Math.max(1, cur + delta);
      betPerLineInput.value = String(next);
      showBetToast();
    }
    betPlusBtn.addEventListener('click', ()=> adjustBet(+2));
    betMinusBtn.addEventListener('click', ()=> adjustBet(-2));

    /* Settings sheet toggle */
    function closeSheet(){ settingsSheet.classList.remove('open'); settingsSheet.setAttribute('aria-hidden','true'); }
    moreBtn.addEventListener('click', (e)=>{ e.stopPropagation(); settingsSheet.classList.toggle('open'); });
    sheetClose.addEventListener('click', closeSheet);
    document.addEventListener('click', (e)=>{ if(settingsSheet.classList.contains('open') && !settingsSheet.contains(e.target) && e.target!==moreBtn) closeSheet(); });
  </script>
</body>
</html>
